---
title: "Analyse des changements de biodiversité"
author: "Équipe Arcteryx"
date: "2025-04-01"
output: html_document
params:
  db_path: NULL
bibliography: references.bib
---

```{r setup, include=FALSE}
#Setup et connexion

library(DBI)
library(RSQLite)
library(ggplot2)
library(dplyr)

# Connexion à la base passée en paramètre
conn <- dbConnect(SQLite(), params$db_path)

# Lire toutes les tables nécessaires depuis la base SQLite
taxo       <- dbReadTable(conn, "taxo")
abondance  <- dbReadTable(conn, "abondance")
source     <- dbReadTable(conn, "source")
geom       <- dbReadTable(conn, "geom")
```

# Résumé

# Introduction résumant les questions

Nous présentons ici trois analyses à différentes échelle taxonomique.

La première analyse s'intéresse à le pygargue à tête blanche (TSN:175420), une espèce indicatrice situé au sommet de la chaine alimentaire et à forte valeur symbolique. Nous analyserons et comparerons l'évolution dans le temps de trois populations au Québec. Ces populations sont suivies via le Breeding Bird Survey et les données couvrent une grande période. Cette analyse permettra de répondre à notre question à savoir comment les mesures gouvernementales peuvent influencer l'état des populations sauvages. Cette analyse fait suite à l'interdiction en 1970 de l'utilisation du DDT, qui avait causé un déclin catastrophique de l'espèce. (source)

La deuxième analyse s'intéresse aux variations temporelles des populations d'oiseaux sur le territoire québécois. L'objectif est d'examiner les tendances à grande échelle, et de déterminer si les populations sont globalement en croissance ou en déclin. Ces populations sont soumises à divers stress anthropiques, comme l'usage des pesticides, les modifications au territoire ou les changements climatiques. Une analyse récente de relevés à long terme sur 529 espèces d'oiseaux d'Amérique du Nord a révélé une perte nette de 2,9 milliards d'individus, soit un déclin de 29% par rapport à 1970 [@rosenberg2019]. Le phénomène est particulièrement marqué pour les espèces se reproduisant en forêt boréale,un écosystème majeur au Québec, avec une baisse d'abondance de 33.1% sur cette période [@rosenberg2019].

# Première analyse - Pygargue à tête blanche

Nous analysons

Dans notre base de donnée, nous avons 5 populations de Pygargue à tête blanche. Nous en avons séléctionné 3 pour lesquelles nos données sont de bonne qualité et pour lesquelles les populations sont suivies sur au moins 15 ans.

Ces trois populations (cle_pop: 978, 979, 980) sont suivies sur (formule qui compte le nombre de ligne avec cle_pop=978). Les données proviennent de la même source (BBS) et elles ont la même unité, un indice standardisé produit par le BBS. Cela nous permet de les comparer directement.

## Méthode

Voici les emplacements des populations. Cela correspond à l'endroit ou la route/échantillonage a été fait, donc ce n'est pas représentatif de la province en entier.

|                    |           |          |                                   |
|----------------|----------------|----------------|-------------------------|
| Population         | Longitude | Latitude | Lieu                              |
| A (cle\_<pop:978>) | -62.73598 | 45.29015 | Governor Lake, Nouvelle-Écosse    |
| B (cle\_<pop:979>) | -66.29159 | 46.66660 | Ludlow Parish, Nouveau-Brunswick  |
| C (cle\_<pop:980>) | -60.79843 | 53.00339 | Labrador, Terre-Neuve et Labrador |

### Informations taxonomiques:

```{r, echo = FALSE}
subset(taxo, TSN==175420)
```

### Source des données

```{r, echo = FALSE}
subset(source, cle_source == 106)
```

## Résultats

```{r}
#Requête des données complètes sur la pygargue à tête blanche (TSN:175420)
#En fait c'est juste sur les 3 populations qu'on va étudier

datapyga <- "
SELECT
  taxo.*,
  population.unit,
  population.cle_pop,
  source.title,
  source.original_source,
  source.publisher,
  source.owner,
  source.license,
  geom.latitude,
  geom.longitude,
  abondance.years,
  abondance.val
FROM taxo
JOIN population ON taxo.TSN = population.TSN
JOIN source ON population.cle_source = source.cle_source
JOIN geom ON population.cle_geom = geom.cle_geom
JOIN abondance ON population.cle_pop = abondance.cle_pop
WHERE population.cle_pop = 978 OR population.cle_pop=979 OR population.cle_pop=980; 
"
datapyga <- dbGetQuery(conn, datapyga)


```

```{r}
#-VISUALISATION-#

library(ggplot2)

# Créer une colonne descriptive pour la légende
datapyga$population_desc <- factor(datapyga$cle_pop,
                                   levels = c(978, 979, 980),
                                   labels = c("Population Nouvelle-Écosse",
                                              "Population Nouveau-Brunswick",
                                              "Population Labrador"))

# Créer le graphique
ggplot(datapyga, aes(x = years, y = val, color = population_desc)) +
  geom_line(size = 0.8) +                        
  geom_point(size = 1.8) +                        
  scale_x_continuous(breaks = pretty(datapyga$years)) +  # Graduation années
  ylim(0, 1) +
  scale_color_manual(values = c("gold", "#4B3621","grey")) + #Notez le choix de couleur
  labs(
    title = "Suivi de populations de Pygargues à tête blanche",
    subtitle = "Données du Relevé des oiseaux nicheurs de l'Amérique du Nord (BBS)",
    x = "Année",
    y = "Indice d'abondance standardisé",
    color = ""
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 10),
    axis.title.x = element_text(size = 10),
    legend.position = "bottom",
    panel.background = element_rect(fill = "#f9f7f0", color = NA),
    plot.background = element_rect(fill = "#f9f7f0", color = NA)
  )
```

## Analyse

On peut observer que ces populations sont toutes les trois en forte hausse, et que cette hausse est en augmentation.

La pygargue semble bien se porter, cela est sans doute dû aux grands efforts de réhabilitation et de protection de l'espèce.

# Deuxième analyse - Fluctuations interannuelles des populations

Les valeurs de biomasse dans notre base de données n'étaient pas interprétables directement parce que les unitées de mesures variaient selon les sources. Afin d'uniformiser le tout, nous avons choisi de représenter la croissance des populations sur une année.

## Méthode

La croissance interanuelle pour une population donnée est calculée avec l'équation suivante pour chaque année d'échantillonnage (excepté la première). Les valeurs pour des années d'échantillonnage qui n'étaient pas contiguës (un intervalle de plus d'un an entre les relevés ex. 2004 - 2007) ont été écartées :

$$Croissance = (Valeur_{année} - Valeur_{année-1})/ Valeur_{année-1}* 100$$

Ensuite, afin d'obtenir une seule valeur par année, nous avons calculé la moyenne de la croissance interannuelle à travers toutes les populations.

```{r,echo=FALSE}
#### Requête des données de taxonomie et d'abondance pour les populations de Aves, avec un calcul de la variation interannuelle moyenne ####

data_graph <- "
WITH toutebrute AS (
SELECT DISTINCT *
FROM taxo,abondance
JOIN population USING(TSN,cle_pop)),
toute AS (
    SELECT *
    FROM toutebrute
    WHERE (cle_pop, years) IN (
        SELECT cle_pop, years
        FROM toutebrute
        GROUP BY cle_pop, years
        HAVING COUNT(*) = 1)
    ),
growth AS (
SELECT 
    t1.class,
    t1.cle_pop,
    t1.years,
    t1.val AS current_value,
    t2.val AS previous_value,
    ROUND(((t1.val - t2.val) / t2.val) * 100, 2) AS growth_yoy
FROM 
    toute t1
LEFT JOIN 
    toute t2
    ON t1.cle_pop = t2.cle_pop AND t1.years = t2.years + 1
ORDER BY 
    t1.cle_pop, t1.years
    )
SELECT 
    g.*,
    ROUND(AVG(g.growth_yoy) OVER (PARTITION BY g.class, g.years), 2) AS moy_growth_yoy
FROM 
    growth g
WHERE g.class IN ('Aves')
ORDER BY 
    g.class, g.cle_pop, g.years
;"

yoy_growth <- dbGetQuery(conn,data_graph)
```

## Résultats

```{r, echo=FALSE}
library(ggplot2)

ggplot(yoy_growth, aes(x=years, y=moy_growth_yoy, group=class,color=class)) +
  ylab("Croissance interannuelle moyenne (%)") +
  xlab("Années") +
  labs(title="Fluctuations des populations d'oiseaux (Aves) au Québec",color="Classe") +
  scale_y_continuous(breaks=seq(-100,700,by=50)) +
  scale_x_continuous(breaks=seq(0,2020,by=5)) +
  geom_line(color="blue")+
  geom_smooth(method=lm,color="black")
```

## Analyse

On remarque des fluctuations importantes dans la croissance interannuelle des populations dans la décennie 1960-1970. Une autre période de variabilité élevée s'observe entre les années 1990 et le début de années 2000. Globalement, la tendance semble être à la baisse sur la période étudiée, avec des pics de croissance de moins en moins fréquents et de faible amplitude.


# Troisième analyse

# Discussion générale

-   Une discussion, enrichie de citations provenant de la littérature scientifique

-   Références interne aux figures et à la bibliographie

# Bibliographie

```{r disconnect, include=FALSE}
#Déconnexion

dbDisconnect(conn)
```
